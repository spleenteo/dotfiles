#!/bin/bash

DEFAULT_PIPE_NAME=".plumber"
PIPE_NAME="${1:-$DEFAULT_PIPE_NAME}"

if [ ! -p $PIPE_NAME ]; then
  mkfifo $PIPE_NAME
fi

if [ -z "$TMUX" ]; then
  echo "Plumbing works better inside a tmux pane! :)"
  exit
fi

# Clear screen
tmux send-keys -R
tmux clear-history

echo "Waiting for commands!"

function hr {
  printf '%*s\n' "${COLUMNS:-$(tput cols)}" '' | tr ' ' ${1:-}
}

# Save tmux pane name
PANE_NAME=`tmux display-message -p '#S:#I.#P'`
echo $PANE_NAME > .plumber-pane

while true; do
  COMMAND=$(cat $PIPE_NAME)
  hr =
  echo $COMMAND
  hr -
  zsh -ic "$COMMAND"
  echo
  hr =
  echo

  # Enter copy mode
  tmux copy-mode -t $PANE_NAME -u
  # Go to the top of buffer
  tmux send-keys -t $PANE_NAME $'\g'
  # Notify
  tmux display "Done plumbing."
done

